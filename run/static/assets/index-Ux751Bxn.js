const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HandsonTable-DMb9EuCm.js","assets/vendor-3XwbvCBC.js","assets/HandsonTable-CeXsD9Sv.css","assets/main-D06-F-Jc.js"])))=>i.map(i=>d[i]);
var us=Object.defineProperty;var xs=(s,t,r)=>t in s?us(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r;var ie=(s,t,r)=>xs(s,typeof t!="symbol"?t+"":t,r);import{k as Ue,r as d,j as e,u as ze,a as hs,F as js,b as gs,c as ps,d as fs,e as bs,o as ys,f as vs,s as Ns,g as ws,h as ks,i as _s,l as $s,m as j,n as k,p as W,q as N,t as Ss,v as T,w as y,x as Y,y as w,z as Ts,A as l,B as D,C as Fe,D as qe,E as Ve,G,H as Es,I as Rs,J as Cs,K as Ps,L as oe,_ as le,M as F,N as H,O,P as Ge,Q as Fs,R as Os,S as Ls,T as Ds,U as X,V as Ke,W as de,X as Ms,Y as Be,Z as U,$ as P,a0 as As,a1 as Is,a2 as Qe,a3 as Hs,a4 as Us,a5 as z,a6 as M,a7 as ge,a8 as zs,a9 as Je,aa as C,ab as v,ac as Z,ad as ee,ae as pe,af as fe,ag as be,ah as $,ai as ye,aj as qs,ak as Vs,al as Gs,am as Ks,an as Bs,ao as Qs,ap as Js,aq as Ws,ar as Ys,as as Xs,at as Zs,au as ve,av as et,aw as Oe,ax as Le,ay as st,az as Ne,aA as We,aB as tt,aC as rt,aD as nt,aE as at,aF as it,aG as ot,aH as lt,aI as ct,aJ as dt,aK as mt,aL as ut,aM as xt,aN as ht}from"./vendor-3XwbvCBC.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const m of i.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function r(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=r(n);fetch(n.href,i)}})();class me{constructor(t,r,a,n,i){this.id=t,this.name=r,this.description=a,this.tasks=n,this.triggers=i}hasTrigger(){return this.triggers.some(t=>!!t.schedule)}getNextFireTime(){const r=this.triggers.filter(a=>!!a.next_fire_time).sort((a,n)=>a.next_fire_time.getTime()-n.next_fire_time.getTime())[0];if(r)return r.next_fire_time}}class jt extends Error{constructor(r,a,n){super(r);ie(this,"data");ie(this,"status");this.data={data:n,status:a},this.status=a}}const gt=`${window.location.protocol}//${window.location.host}/api`,se=gt,we=Ue.create({prefixUrl:se,credentials:"include",redirect:"follow"}),ke=()=>se,L=async(s,t)=>(await we.get(s,t)).json(),Ye=async(s,t)=>{try{return await we.post(s,t).json()}catch(r){const a=r;throw new jt(a.message,a.response.status,await a.response.json())}},pt=()=>{const s=new URL(se);return s.pathname=s.pathname.replace(/api$/,""),s},De=s=>`${se}/pipelines/${s}/run`,ft=async()=>await L("auth/whoami"),bt=async()=>{await Ye("auth/logout")},yt=()=>({queryKey:["pipelines"],queryFn:async()=>{const s=await L("pipelines/");return s.forEach(t=>{t.triggers.forEach(r=>{r.next_fire_time&&(r.next_fire_time=new Date(r.next_fire_time))})}),s.map(t=>new me(t.id,t.name,t.description,t.tasks,t.triggers))},initialData:[]}),_e=s=>({queryKey:["pipeline",s],queryFn:async()=>{const t=await L(`pipelines/${s}`);return t.triggers.forEach(r=>{r.next_fire_time&&(r.next_fire_time=new Date(r.next_fire_time))}),new me(t.id,t.name,t.description,t.tasks,t.triggers)},initialData:new me("","","",[],[]),enabled:!!s}),vt=s=>({queryKey:["pipeline-input",s],queryFn:async()=>await L(`pipelines/${s}/input-schema`)}),$e=(s,t)=>({queryKey:["runs",s,t],queryFn:async()=>{const a=await L("runs/",{searchParams:{pipeline_id:s??"",trigger_id:t??""}});return a.forEach(n=>{n.start_time=new Date(n.start_time)}),a},initialData:[]}),Me=(s,t,r)=>({queryKey:["runs",s,t,r],queryFn:async()=>{const a=await L(`runs/${r}`);return a.start_time=new Date(a.start_time),a},enabled:!!(s&&t&&r)}),Nt=s=>({queryKey:["logs",s],queryFn:async()=>{const t=await we.get(`runs/${s}/logs`).text();return t?t.split(`
`).map((r,a)=>{const n=JSON.parse(r);return n.id=a,n.timestamp=new Date(n.timestamp),n}):[]},enabled:!!s,initialData:[]}),Xe=(s,t)=>`runs/${s}/data/${t}`,wt=(s,t)=>({queryKey:["getRunData",{runId:s,taskId:t}],queryFn:async()=>await L(Xe(s,t))}),Ze=(s,t)=>({async mutationFn(r){return await Ye(`pipelines/${s}/run`,{json:{trigger_id:t,params:r}})}}),kt=()=>({queryKey:["gh","latest-release"],queryFn:async()=>await Ue.get("https://api.github.com/repos/yhdsl/plombery/releases/latest").json()}),es=d.createContext({isAuthenticated:!1,isAuthenticationEnabled:!0,isLoading:!0,logout:async()=>{},user:null}),_t=(s,t)=>{switch(t.type){case"LOGIN":return{...s,isAuthenticated:!0,isAuthenticationEnabled:t.payload.isAuthenticationEnabled,user:t.payload.user};case"LOGOUT":return{...s,isAuthenticated:!1,user:null};case"POPULATE":return{...s,user:t.payload?{...s.user,...t.payload}:null};case"STOP_LOADING":return{...s,isLoading:!1};default:throw new Error("Unknown action type")}},$t=({children:s})=>{const[t,r]=d.useReducer(_t,{isAuthenticated:!1,isAuthenticationEnabled:!0,isLoading:!0,logout:async()=>{await bt(),r({type:"LOGOUT"})},user:null});return d.useEffect(()=>{(async()=>{try{const{is_authentication_enabled:n,user:i}=await ft();(n&&i||!n)&&r({type:"LOGIN",payload:{user:i,isAuthenticationEnabled:n}})}catch(n){console.error(n)}finally{r({type:"STOP_LOADING"})}})()},[]),e.jsx(es.Provider,{value:t,children:t.isAuthenticationEnabled&&t.isLoading?"加载中...":s})},Se=()=>d.useContext(es),St=s=>`translate${s==="bottom"||s==="top"?"Y":"X"}(${s==="bottom"||s==="right"?"-":"+"}10%)`;function Tt({initialOpen:s=!1,placement:t="bottom",modal:r,open:a,onOpenChange:n}={}){const[i,m]=d.useState(s),[c,h]=d.useState(),[o,x]=d.useState(),p=a??i,S=n??m,_=fs({placement:t,open:p,onOpenChange:S,whileElementsMounted:bs,middleware:[ys(5),vs({fallbackAxisSideDirection:"end"}),Ns({padding:5})]}),f=_.context,u=ws(f,{enabled:a==null}),g=ks(f),b=_s(f),R=$s([u,g,b]);return d.useMemo(()=>({open:p,setOpen:S,...R,..._,modal:r,labelId:c,descriptionId:o,setLabelId:h,setDescriptionId:x}),[p,S,R,_,r,c,o])}const ss=d.createContext(null),te=()=>{const s=d.useContext(ss);if(s==null)throw new Error("Popover components must be wrapped in <Popover />");return s};function Et({children:s,modal:t=!0,...r}){const a=Tt({modal:t,...r});return e.jsx(ss.Provider,{value:a,children:s})}const Rt=d.forwardRef(function({children:t,asChild:r=!1,...a},n){const i=te(),m=t.ref,c=ze([i.refs.setReference,n,m]);return r&&d.isValidElement(t)?d.cloneElement(t,i.getReferenceProps({ref:c,...a,...t.props,"data-state":i.open?"open":"closed"})):e.jsx("button",{ref:c,type:"button","data-state":i.open?"open":"closed",...i.getReferenceProps(a),children:t})}),Ct=d.forwardRef(function(t,r){const{context:a,...n}=te(),i=ze([n.refs.setFloating,r]),{isMounted:m,styles:c}=hs(a,{initial:({side:h})=>({opacity:0,transform:St(h)})});return e.jsx(js,{children:m&&e.jsx(gs,{context:a,modal:n.modal,children:e.jsx("div",{ref:i,style:{position:n.strategy,top:n.y??0,left:n.x??0,width:"max-content",zIndex:20,...t.style,...c},"aria-labelledby":n.labelId,"aria-describedby":n.descriptionId,...n.getFloatingProps(t),children:t.children})})})});d.forwardRef(function({children:t,...r},a){const{setDescriptionId:n}=te(),i=ps();return d.useLayoutEffect(()=>(n(i),()=>n(void 0)),[i,n]),e.jsx("p",{...r,ref:a,id:i,children:t})});d.forwardRef(function(t,r){const{setOpen:a}=te();return e.jsx("button",{type:"button",ref:r,...t,onClick:n=>{var i;(i=t.onClick)==null||i.call(t,n),a(!1)}})});const Pt=()=>{const{logout:s,user:t}=Se();return t?e.jsxs(j,{className:"gap-4 mt-8",children:[e.jsxs("div",{children:[e.jsx(k,{children:t.name}),e.jsx(W,{children:t.email})]}),e.jsx(N,{size:"xs",variant:"secondary",color:"rose",icon:Ss,onClick:async()=>await s()})]}):e.jsx("div",{children:"Not authenticated"})},Ae="0.4.1",ts=0,ue=1,Ie=2,Ft={[ts]:"light",[ue]:"dark"},V="plomberyTheme",Ot=()=>{const s=localStorage[V]==="dark"?ue:V in localStorage?ts:Ie,[t,r]=d.useState(s);return e.jsx(qe,{onIndexChange:a=>{let n=!1;return a===Ie?(localStorage.removeItem(V),n=window.matchMedia("(prefers-color-scheme: dark)").matches):(n=a===ue,localStorage[V]=Ft[a]),n?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),r(a)},index:t,children:e.jsxs(Ve,{variant:"solid",children:[e.jsx(G,{icon:Es,children:"浅色主题"}),e.jsx(G,{icon:Rs,children:"深色主题"}),e.jsx(G,{icon:Cs,children:"跟随系统"})]})})},Lt=(s,t)=>{const r=s.replace(/^v/,"").split(".").map(Number),a=t.replace(/^v/,"").split(".").map(Number);for(let n=0;n<r.length;n++){if(r[n]>a[n])return!0;if(r[n]<a[n])return!1}return!1},Dt=()=>{var c;const[s,t]=d.useState(!1),{user:r,isAuthenticationEnabled:a}=Se(),n=T({...kt(),enabled:s});let i=e.jsx(Ps,{});if(a&&r){const h=r.name.split(" ");i=h.length>1?`${h.at(0)[0]}${h.at(-1)[0]}`:h[0]}const m=n.isSuccess?Lt(Ae,n.data.tag_name):!1;return e.jsxs(Et,{placement:"bottom-start",open:s,onOpenChange:t,children:[e.jsx(Rt,{onClick:()=>t(!0),children:e.jsx("div",{className:"flex justify-center items-center font-medium dark:bg-dark-tremor-background dark:ring-dark-tremor-ring ring-1 ring-slate-300 text-indigo-500 rounded-full hover:ring-2 hover:ring-indigo-400 dark:hover:ring-indigo-700 transition-shadow",style:{width:34,height:34},children:i})}),e.jsx(Ct,{children:e.jsxs(y,{className:"p-0 pt-4 shadow-xl z-20",children:[e.jsxs(Y,{children:[e.jsxs("a",{className:"flex items-center px-6 py-2 hover:bg-tremor-brand-faint hover:dark:bg-dark-tremor-brand-faint transition-colors no-underline",href:ke().replace(/\/api$/,"/docs"),target:"_blank",rel:"noopener noreferrer",children:[e.jsx(w,{icon:Ts,color:"slate",className:"mr-3"}),e.jsx(l,{className:"flex-grow no-underline border-0",children:"REST API 文档"}),e.jsx(w,{icon:D,color:"slate"})]}),e.jsxs("a",{className:"flex items-center px-6 py-2 hover:bg-tremor-brand-faint hover:dark:bg-dark-tremor-brand-faint transition-colors no-underline",href:"https://github.com/lucafaggianelli/plombery",target:"_blank",rel:"noopener noreferrer",children:[e.jsx(w,{icon:Fe,color:"slate",className:"mr-3"}),e.jsx(l,{className:"flex-grow no-underline border-0",children:"GitHub (官方)"}),e.jsx(w,{icon:D,color:"slate"})]}),e.jsxs("a",{className:"flex items-center px-6 py-2 hover:bg-tremor-brand-faint hover:dark:bg-dark-tremor-brand-faint transition-colors no-underline",href:"https://github.com/yhdsl/plombery",target:"_blank",rel:"noopener noreferrer",children:[e.jsx(w,{icon:Fe,color:"slate",className:"mr-3"}),e.jsx(l,{className:"flex-grow no-underline border-0",children:"GitHub (非官方)"}),e.jsx(w,{icon:D,color:"slate"})]})]}),e.jsxs("div",{className:"p-6",children:[e.jsx(Ot,{}),a&&e.jsx(Pt,{})]}),e.jsxs("div",{className:"px-6 pb-3 text-center text-tremor-content-subtle dark:text-dark-tremor-content-subtle text-sm",children:["Plombery v",Ae," ",m&&e.jsxs("span",{className:"text-xs text-amber-600",children:["(有新版本 v",(c=n.data)==null?void 0:c.tag_name," 可用)"]})]})]})})]})},re=({children:s,header:t})=>e.jsxs("div",{className:"bg-slate-100 dark:bg-slate-950 p-6 sm:p-10 min-h-screen",children:[e.jsxs(j,{className:"items-start gap-4 md:gap-8",children:[t&&e.jsx("div",{className:"flex-grow max-w-full",children:t}),e.jsx(Dt,{})]}),e.jsx("main",{children:s})]}),q=({children:s,footer:t,isOpen:r,subtitle:a,title:n,onClose:i})=>e.jsx(oe,{show:r,as:d.Fragment,children:e.jsxs(le,{onClose:i,className:"relative z-50",children:[e.jsx(oe.Child,{as:d.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black/30 dark:bg-black/50 backdrop-blur-sm","aria-hidden":"true"})}),e.jsx("div",{className:"fixed inset-0 flex w-screen items-center justify-center p-12",children:e.jsx(oe.Child,{as:d.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 translate-y-1/3",enterTo:"opacity-100 translate-y-0",leave:"ease-in duration-300",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 -translate-y-1/3",children:e.jsx(le.Panel,{className:"max-w-full",children:e.jsxs(y,{children:[n&&e.jsx(le.Title,{children:e.jsx(k,{children:n})}),a&&e.jsx(W,{children:a}),e.jsx("div",{className:(n||a)&&"mt-6",children:s}),t&&e.jsx(j,{className:"justify-end space-x-6 mt-6",children:t})]})})})})]})}),Mt=({label:s,...t})=>{const r=d.createRef();return e.jsxs("div",{children:[e.jsx("input",{type:"range",onInput:a=>r.current&&(r.current.value=a.target.value),className:"w-full cursor-ew-resize appearance-none accent-indigo-500 h-2 bg-tremor-background border border-tremor-border dark:border-dark-tremor-border dark:bg-dark-tremor-background rounded",...t}),e.jsxs(F,{numItems:3,className:"items-baseline",children:[e.jsx(H,{children:e.jsxs("div",{className:"ml-1 inline-block",children:[e.jsx("div",{className:"border-r border-slate-300 dark:border-slate-600 h-2 mx-auto",style:{width:1}}),e.jsx(l,{children:t.min})]})}),e.jsx(j,{className:"justify-center",children:e.jsx(l,{children:e.jsx(O,{children:e.jsx("output",{ref:r,className:"px-2 py-1 rounded bg-tremor-background-subtle dark:bg-dark-tremor-background-subtle block truncate text-center",children:t.defaultValue})})})}),e.jsx(j,{className:"justify-end",children:e.jsxs("div",{className:"mr-1",children:[e.jsx("div",{className:"border-r border-slate-300 dark:border-slate-600 h-2 mx-auto",style:{width:1}}),e.jsx(l,{children:t.max})]})})]})]})},At={checkbox:s=>e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("input",{id:`${s.name}_hidden`,name:s.name,type:"hidden",checked:!0,readOnly:!0,value:"false"}),e.jsx("input",{id:s.name,name:s.name,type:"checkbox",defaultChecked:s.defaultValue==="true",className:"w-4 h-4 accent-indigo-500 bg-tremor-background rounded dark:bg-dark-tremor-background cursor-pointer"}),e.jsx("label",{htmlFor:s.name,className:"pl-2 cursor-pointer",children:e.jsx(l,{children:s.label})})]}),number:s=>{const t=s.value.minimum??s.value.exclusiveMinimum,r=s.value.maximum??s.value.exclusiveMaximum;return e.jsx(Fs,{name:s.name,min:t,max:r,defaultValue:s.defaultValue,required:s.required})},range:s=>{const t=s.value.minimum??s.value.exclusiveMinimum??0,r=s.value.maximum??s.value.exclusiveMaximum??0,a=s.type==="number"?(r-t)/10:1;return e.jsx(Mt,{name:s.name,label:s.label,min:t,max:r,step:a,defaultValue:s.defaultValue,required:s.required})},select:s=>{const[t,r]=d.useState(s.defaultValue||"");return e.jsxs("div",{children:[e.jsx(Os,{defaultValue:s.defaultValue,onValueChange:r,value:t,children:s.value.enum.map(a=>e.jsx(Ls,{value:a.toString(),children:a==null?void 0:a.toString()},a==null?void 0:a.toString()))}),e.jsx("input",{type:"hidden",name:s.name,value:t})]})},text:s=>{const t=s.value.format==="password"?"password":"text";return e.jsx(Ds,{type:t,name:s.name,placeholder:s.label,defaultValue:s.defaultValue})}},It=s=>{let t="text";if(s.type==="number"||s.type==="integer"){const r=s.value.minimum??s.value.exclusiveMinimum,a=s.value.maximum??s.value.exclusiveMaximum;r!==void 0&&a!==void 0?t="range":t="number"}else s.type==="enum"?t="select":s.type==="boolean"&&(t="checkbox");return At[t](s)},Ht=({errors:s={},schema:t})=>{const r=d.useCallback(i=>{const m=t.definitions||t.$defs;if(!m)return;const c=i.split("/").pop();return m[c]},[t]),a=t.properties;if(!a)return e.jsx(l,{className:"mt-4",children:"该管道不支持输入参数，但你仍然可以手动运行!"});const n=Object.entries(a).map(([i,m])=>{var _,f,u;if(typeof m=="boolean")return;let c=m,h;const o=c.title||i;if(m.allOf){const g=m.allOf[0];if(h=(_=m.default)==null?void 0:_.toString(),g.$ref){const b=r(g.$ref);b&&(c=b)}}else if(m.$ref){const g=r(m.$ref);g&&(c=g)}else h=(f=c.default)==null?void 0:f.toString();const x=(c.enum?"enum":Array.isArray(c.type)?c.type[0]:c.type)||"string",p=((u=t.required)==null?void 0:u.includes(i))??!1,S=It({defaultValue:h,label:o,name:i,required:p,type:x,value:c});return e.jsxs("div",{children:[e.jsxs(j,{className:"justify-between",children:[e.jsxs(l,{className:"mb-2",children:[o,p&&" *"]}),c.description&&e.jsx(w,{icon:Ge,tooltip:c.description,color:"neutral"})]}),S,s[i]&&e.jsx(l,{color:"rose",className:"mt-1",children:s[i]})]},i)});return e.jsx(j,{className:"gap-4 flex-col items-stretch",children:n})},Te=({pipeline:s})=>{var h;const[t,r]=d.useState(!1),a=X(),n=T({...vt(s.id),enabled:t}),i=Ke(Ze(s.id)),m=i.isError&&i.error.status===422?Object.fromEntries(i.error.data.data.detail.map(o=>[o.loc.join("."),o.msg])):void 0,c=(h=i.error)==null?void 0:h.message;return e.jsxs(e.Fragment,{children:[e.jsx(N,{color:"indigo",variant:"secondary",size:"xs",icon:de,onClick:()=>r(!0),children:"运行"}),e.jsx(q,{isOpen:t,title:`手动运行 "${s.name}"`,onClose:()=>r(!1),children:e.jsxs("form",{onSubmit:async o=>{o.preventDefault();const x=Object.fromEntries(new FormData(o.target).entries());try{const p=await i.mutateAsync(x);a(`/pipelines/${p.pipeline_id}/triggers/${p.trigger_id}/runs/${p.id}`),r(!1)}catch(p){console.error(p)}},children:[n.isPending||n.isFetching?"加载中...":n.isError?"错误":e.jsxs("div",{style:{width:350},children:[e.jsx(Ht,{schema:n.data,errors:m}),c&&e.jsx(l,{className:"mt-2",color:"rose",children:c})]}),e.jsxs(j,{className:"justify-end space-x-6 mt-6",children:[e.jsx(N,{type:"button",variant:"secondary",color:"indigo",onClick:()=>{r(!1)},disabled:i.isPending,children:"关闭"}),e.jsx(N,{color:"indigo",type:"submit",icon:de,disabled:i.isPending,children:"运行"})]})]})})]})},Ut=()=>e.jsx("div",{className:"tremor-Badge-icon -ml-1 mr-1.5 h-4 w-4 animate-spin",children:e.jsx(Ms,{})}),K={pending:"slate",completed:"emerald",failed:"rose",cancelled:"slate",running:"blue",warning:"amber"},xe={pending:As,completed:Is,failed:Qe,cancelled:Hs,running:Ut,warning:Us},he=["cyan","violet","pink","emerald","orange","stone","fuchsia"],rs=s=>Object.fromEntries(s.map((t,r)=>[t.id,`bg-${he[r%he.length]}-500`])),A=(s,t=!1)=>{if(t){const r=Be(s,s.getTimezoneOffset());return U(r,"yyyy年MMMdd日 HH:mm:ss",{locale:P})+" (UTC)"}else return U(s,"yyyy年MMMdd日 HH:mm:ss (OOOO)",{locale:P})},B=(s,t=!1)=>{if(t){const r=Be(s,s.getTimezoneOffset());return U(r,"HH:mm:ss.SSS",{locale:P})+" (UTC)"}else return U(s,"HH:mm:ss.SSS",{locale:P})},Q=s=>U(s,"yyyy年MMMdd日",{locale:P}),zt=new Intl.NumberFormat,qt=s=>zt.format(s),ns=s=>s.replace("pending","等待中...").replace("running","运行中...").replace("completed","成功").replace("failed","失败").replace("cancelled","取消").replace("warning","警告"),Vt=()=>{const s=T(yt());if(s.isPending)return e.jsx("div",{children:"加载中..."});if(s.isError)return e.jsx("div",{children:"出现了一个错误"});const t=s.data;return e.jsxs(y,{children:[e.jsx(k,{children:"管道列表"}),e.jsxs(Y,{children:[t.map(r=>e.jsxs(z,{className:"gap-x-1",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx(l,{className:"truncate",children:e.jsx(O,{children:e.jsx(M,{to:`/pipelines/${r.id}`,children:r.name})})}),r.description&&e.jsx(l,{className:"truncate",children:r.description})]}),r.hasTrigger()&&e.jsxs("div",{className:"min-w-0",title:A(r.getNextFireTime(),!1),children:[e.jsx(l,{className:"truncate",children:"下次运行时间"}),e.jsx(l,{className:"truncate",children:e.jsx(O,{children:ge(r.getNextFireTime(),{addSuffix:!0,includeSeconds:!0,locale:P})})})]}),e.jsx(Te,{pipeline:r})]},r.id)),t.length===0&&e.jsxs("div",{className:"mt-4",children:[e.jsx(l,{className:"text-center italic",children:"没有管道，哪也跳不进去"}),e.jsx("div",{className:"text-center mt-2 text-sm",children:e.jsxs("a",{href:"https://yhdsl.github.io/plombery/pipelines/",target:"_blank",className:"inline-flex items-center gap-2 bg-indigo-50/30 hover:bg-indigo-50 dark:bg-indigo-950/50 dark:hover:bg-indigo-950 rounded-sm px-4 py-2 text-indigo-500 transition-colors duration-300 cursor-pointer no-underline",rel:"noopener noreferrer",children:["如何创建管道",e.jsx(w,{icon:D,size:"sm",className:"p-0",color:"indigo"})]})})]})]})]})},E=zs(pt().toString(),{transports:["websocket"],path:"/ws/socket.io"}),as=({status:s})=>e.jsx(Je,{color:K[s],icon:xe[s],children:ns(s)}),is=({startTime:s})=>{const[t,r]=d.useState(Date.now()-s.getTime());return d.useEffect(()=>{const a=setInterval(()=>{r(Date.now()-s.getTime())},500);return()=>{clearInterval(a)}}),e.jsx("span",{children:(t/1e3).toFixed(2)})},Ee=({query:s})=>s.isError?e.jsxs(e.Fragment,{children:[e.jsxs(j,{justifyContent:"start",children:[e.jsx(w,{icon:Qe,color:"rose",className:"pl-0"}),e.jsx(k,{children:"获取数据时出错"})]}),e.jsx(l,{children:s.error.message}),e.jsx(j,{justifyContent:"center",className:"mt-4",children:e.jsx(N,{color:"rose",variant:"light",size:"xs",onClick:()=>s.refetch(),children:"重试"})})]}):null,ne="animate-pulse rounded",ae="bg-slate-200 dark:bg-slate-700",Gt=({className:s})=>e.jsx("div",{className:Z("h-10",ne,ae,s)}),Kt=({className:s})=>e.jsx("div",{className:Z("h-28",ne,ae,s)}),je=({className:s})=>e.jsx(l,{className:Z(ne,ae,s),children:" "}),os=({className:s})=>e.jsx(ee,{className:Z("w-24",ne,ae,s),children:" "}),Bt=({columns:s=6,rows:t=10})=>new Array(t).fill(1).map((r,a)=>e.jsx(C,{className:"animate-pulse",children:new Array(s).fill(1).map((n,i)=>e.jsx(v,{children:e.jsx(je,{})},i))},a)),Re=({pipelineId:s,query:t,triggerId:r})=>{const[a,n]=d.useState(t.data||[]),i=pe(),m=X(),c=d.useCallback(o=>{if(o.run.start_time=new Date(o.run.start_time),o.run.trigger_id=o.trigger,o.run.status==="running")n([o.run,...a]);else{let x=[...a];const p=x.findIndex(S=>S.id===o.run.id);p>=0?x[p]=o.run:x=[o.run,...x],n(x),i.invalidateQueries({queryKey:["runs",s,r]})}},[s,i,a,r]);d.useEffect(()=>(E.on("run-update",c),()=>{E.off("run-update",c)}),[s]),d.useEffect(()=>{var o;(o=t.data)!=null&&o.length&&n(t.data)},[t.data]);const h=4+ +!!s+ +!!r;return e.jsxs(y,{children:[e.jsx(k,{children:"运行状态"}),e.jsxs(fe,{className:"overflow-auto max-h-[50vh]",children:[e.jsx(be,{className:"sticky top-0 bg-tremor-background dark:bg-dark-tremor-background shadow dark:shadow-tremor-dropdown z-10",children:e.jsxs(C,{children:[e.jsx($,{className:"text-right",children:"#"}),e.jsx($,{children:"状态"}),!s&&e.jsx($,{children:"管道ID"}),!r&&e.jsx($,{children:"触发器ID"}),e.jsx($,{children:"启动时间"}),e.jsx($,{className:"text-right",children:"运行时长"})]})}),e.jsxs(ye,{children:[a.map(o=>e.jsxs(C,{className:"cursor-pointer hover:bg-slate-50 dark:hover:bg-dark-tremor-background-subtle transition-colors",onClick:()=>m(`/pipelines/${o.pipeline_id}/triggers/${o.trigger_id}/runs/${o.id}`),children:[e.jsx(v,{className:"text-right",children:o.id}),e.jsx(v,{children:e.jsx(as,{status:o.status})}),!s&&e.jsx(v,{children:e.jsx(M,{to:`/pipelines/${o.pipeline_id}`,className:"link--arrow",title:"单击查看管道信息",onClick:x=>x.stopPropagation(),children:o.pipeline_id})}),!r&&e.jsx(v,{children:e.jsx(M,{to:`/pipelines/${o.pipeline_id}/triggers/${o.trigger_id}`,className:"link--arrow",title:"单击查看触发器信息",onClick:x=>x.stopPropagation(),children:o.trigger_id})}),e.jsx(v,{title:A(o.start_time,!1),children:e.jsx(l,{children:qs(new Date,o.start_time)<=1?ge(o.start_time,{addSuffix:!0,includeSeconds:!0,locale:P}):A(o.start_time)})}),e.jsxs(v,{className:"text-right",children:[o.status!=="running"?(o.duration/1e3).toFixed(2):e.jsx(is,{startTime:o.start_time})," ","s"]})]},o.id)),(t.isFetching||t.isPending)&&e.jsx(Bt,{columns:h}),t.isError&&e.jsx(C,{children:e.jsx(v,{colSpan:h,children:e.jsx(Ee,{query:t})})})]})]})]})},Qt=()=>{const s=T($e());return e.jsx(re,{header:e.jsx(e.Fragment,{children:e.jsx(k,{children:"Plombery"})}),children:e.jsxs(F,{numItemsMd:2,className:"gap-6 mt-6",children:[e.jsx(H,{children:e.jsx(Vt,{})}),e.jsx(H,{children:e.jsx(Re,{query:s})})]})})},Jt=()=>e.jsx("div",{className:"bg-slate-100 dark:bg-slate-950 h-screen flex justify-center items-center",children:e.jsxs(y,{className:"w-auto",children:[e.jsx("div",{className:"w-12 rounded-full mx-auto mb-4",children:e.jsx("img",{src:"/mario-pipe-flower.png",alt:"Plombery logo"})}),e.jsx(k,{className:"mb-6",children:"欢迎使用 Plombery"}),e.jsx(N,{onClick:()=>{location.href=`${ke()}/auth/login`},size:"lg",color:"indigo",className:"shadow-none w-full",children:"登录"})]})}),I=()=>e.jsx(l,{children:"/"}),Ce=({pipeline:s,trigger:t,run:r,className:a})=>{if(r&&!t)throw new Error;return e.jsxs(j,{className:`gap-x-2 justify-start flex-wrap ${a||""}`,children:[e.jsx(l,{children:e.jsx(M,{to:"/",children:"管道"})}),e.jsx(I,{}),e.jsx(l,{children:t?e.jsx(M,{to:`/pipelines/${s.id}`,children:s.name}):s.name}),t&&e.jsxs(e.Fragment,{children:[e.jsx(I,{}),e.jsx(l,{children:"触发器"}),e.jsx(I,{}),e.jsx(l,{children:r?e.jsx(M,{to:`/pipelines/${s.id}/triggers/${t.id}`,children:t.name}):t.name})]}),r&&t&&e.jsxs(e.Fragment,{children:[e.jsx(I,{}),e.jsx(l,{children:"运行"}),e.jsx(I,{}),e.jsxs(l,{children:["#",r.id]})]})]})},ce=s=>(s/1e3).toFixed(1)+" s",Wt=()=>e.jsxs(y,{children:[e.jsx(l,{children:"运行时长 (平均)"}),e.jsx(os,{}),e.jsx(Kt,{className:"mt-6"})]}),ls=({query:s})=>{if(s.isPending)return e.jsx(Wt,{});if(s.isError)return e.jsx(y,{children:e.jsx(Ee,{query:s})});const t=s.data.filter(n=>n.status==="completed").reverse(),r=t.reduce((n,i)=>n+i.duration,0)/t.length||0,a=n=>{const{payload:i,active:m,label:c}=n;return!m||!i?null:e.jsx("div",{className:"w-56 rounded-tremor-default border border-tremor-border bg-tremor-background p-2 text-tremor-default shadow-tremor-dropdown dark:bg-dark-tremor-background dark:ring-dark-tremor-ring dark:shadow-dark-tremor-card dark:border-dark-tremor-brand",children:i.map((h,o)=>e.jsxs("div",{className:"flex flex-1 space-x-2.5",children:[e.jsx("div",{className:`flex w-1 flex-col bg-${h.color}-500 rounded`}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"font-medium text-tremor-content",children:["#",c," 运行时长"]}),e.jsx("p",{className:"font-medium text-tremor-content-emphasis",children:ce(Number(h.value))})]})]},o))})};return e.jsxs(y,{children:[e.jsx(j,{className:"items-start",children:e.jsx(l,{children:"运行时长 (平均)"})}),e.jsx(j,{className:"justify-start items-baseline space-x-3 truncate",children:e.jsx(ee,{children:ce(r)})}),e.jsx(Vs,{data:t,index:"id",categories:["duration"],colors:["indigo"],valueFormatter:ce,yAxisWidth:40,showLegend:!1,autoMinValue:!0,className:"mt-6 h-28",noDataText:"无数据",customTooltip:a})]})},Yt=({subject:s})=>e.jsxs(y,{children:[e.jsx(l,{children:"成功运行"}),e.jsx(os,{}),e.jsxs(l,{className:"mt-4",children:[s," 健康监控"]}),e.jsx(Gt,{}),e.jsxs(j,{className:"mt-2",children:[e.jsx(je,{className:"w-20"}),e.jsx(je,{className:"w-20"})]})]}),cs=({query:s,subject:t})=>{var c,h;if(s.isPending||s.isFetching)return e.jsx(Yt,{subject:t});if(s.isError)return e.jsx(y,{children:e.jsx(Ee,{query:s})});const r=[...s.data].reverse(),n=r.filter(o=>o.status==="completed").length/r.length*100||0,i=(c=r[0])==null?void 0:c.start_time,m=(h=r[r.length-1])==null?void 0:h.start_time;return e.jsxs(y,{children:[e.jsx(j,{className:"items-start",children:e.jsx(l,{children:"健康状态"})}),e.jsx(j,{className:"justify-start items-baseline space-x-3 truncate",children:e.jsxs(ee,{children:[n.toFixed(1)," ",e.jsx("span",{className:"text-lg",children:"%"})]})}),r.length?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"mt-4",children:e.jsxs(l,{children:[t.replace("Trigger","触发器").replace("Pipeline","管道"),"健康监控"]})}),e.jsx(Gs,{className:"mt-2",data:r.map(o=>({key:o.id,color:K[o.status],tooltip:`#${o.id} ${ns(o.status)}`}))})]}):e.jsx(l,{className:"text-center mt-8",children:e.jsxs(Ks,{children:["该",t.replace("Trigger","触发器").replace("Pipeline","管道"),"尚未运行过"]})}),e.jsxs(j,{className:"mt-2",children:[e.jsx(l,{children:i&&Q(i)}),e.jsx(l,{children:m&&Q(m)})]})]})},Xt=({pipeline:s})=>{const t=X();return e.jsxs(y,{children:[e.jsx(k,{children:"触发器信息"}),e.jsxs(fe,{children:[e.jsx(be,{className:"sticky top-0 bg-tremor-background dark:bg-dark-tremor-background shadow dark:shadow-tremor-dropdown z-10",children:e.jsxs(C,{children:[e.jsx($,{children:"名称"}),e.jsx($,{children:"调度"}),e.jsx($,{children:"下次运行时间"})]})}),e.jsxs(ye,{children:[s.triggers.map(r=>e.jsxs(C,{className:"cursor-pointer hover:bg-slate-50 dark:hover:bg-dark-tremor-background-subtle transition-colors",onClick:()=>t(`/pipelines/${s.id}/triggers/${r.id}`),children:[e.jsx(v,{children:r.name}),e.jsx(v,{children:e.jsx(l,{children:r.schedule})}),e.jsx(v,{title:A(s.getNextFireTime(),!1),children:ge(s.getNextFireTime(),{includeSeconds:!0,addSuffix:!0,locale:P})})]},r.id)),s.triggers.length===0&&e.jsx(C,{children:e.jsxs(v,{colSpan:3,children:[e.jsx(l,{className:"text-center italic",children:"该管道尚未设置触发器，仅能手动运行"}),e.jsx("div",{className:"text-center mt-2 text-sm",children:e.jsxs("a",{href:"https://yhdsl.github.io/plombery/triggers/",target:"_blank",className:"inline-flex items-center gap-2 bg-indigo-50/30 hover:bg-indigo-50 dark:bg-indigo-950/50 dark:hover:bg-indigo-950 rounded-sm px-4 py-2 text-indigo-500 transition-colors duration-300 cursor-pointer no-underline",rel:"noopener noreferrer",children:["如何创建触发器",e.jsx(w,{icon:D,size:"sm",className:"p-0",color:"indigo"})]})})]})})]})]})]})},Zt=({className:s,content:t})=>{const[r,a]=d.useState(!1),n=d.useRef();return e.jsx(N,{variant:"light",color:"indigo",size:"sm",icon:r?Bs:Qs,tooltip:"单击复制",className:s,onClick:()=>{navigator.clipboard.writeText(t),a(!0),n.current=setTimeout(()=>a(!1),3e3)}})},ds=({pipelineId:s,triggerId:t})=>{const[r,a]=d.useState(!1),n=document.documentElement.classList.contains("dark"),i=[{language:"python",name:"Python",code:`import httpx

httpx.post('${De(s)}', json={${t?`
  "trigger_id": "${t}",`:""}
  "params": {
    "name": "value",
  }
})`},{language:"js",name:"JavaScript",code:`fetch('${De(s)}', {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({${t?`
    trigger_id: '${t}',`:""}
    params: {},
  }),
})`}];return e.jsxs(e.Fragment,{children:[e.jsx(N,{color:"indigo",variant:"secondary",size:"xs",icon:Ge,onClick:()=>a(!0)}),e.jsx(q,{isOpen:r,title:"使用 HTTP 请求运行",subtitle:"你可以通过使用 HTTP 请求来运行管道和触发器",onClose:()=>a(!1),children:e.jsxs(qe,{children:[e.jsx(Ve,{className:"mt-8",children:i.map(m=>e.jsx(G,{children:m.name},m.name))}),e.jsx(Js,{children:i.map(m=>e.jsx(Ws,{children:e.jsxs("div",{className:"mt-6 relative group",children:[e.jsx(Ys,{language:m.language,style:n?Xs:Zs,customStyle:{borderRadius:8},children:m.code}),e.jsx(Zt,{content:m.code,className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-200/80 dark:bg-slate-800/80 rounded p-2"})]})},m.name))})]})})]})},er=()=>{const t=ve().pipelineId,r=T(_e(t)),a=T($e(t));if(r.isPending)return e.jsx("div",{children:"加载中..."});if(r.isError)return e.jsx("div",{children:"出现了一个错误"});const n=r.data;return e.jsxs(re,{header:e.jsxs("div",{children:[e.jsxs(j,{className:"items-start",children:[e.jsxs(j,{className:"justify-start items-start md:items-center flex-col md:flex-row min-w-0",children:[e.jsxs(k,{className:"truncate max-w-full",children:['管道 "',n.name,'"']}),n.description&&e.jsxs(l,{className:"truncate max-w-full",children:[e.jsx("span",{className:"hidden md:inline mx-2",children:"·"}),n.description]})]}),e.jsx(Te,{pipeline:n})]}),e.jsx(Ce,{pipeline:n,className:"mt-4 md:mt-0"})]}),children:[e.jsxs(F,{numItemsMd:2,numItemsLg:3,className:"gap-6 mt-6",children:[e.jsxs(y,{className:"flex flex-col h-full",children:[e.jsx(k,{children:"任务信息"}),e.jsxs(Y,{children:[n.tasks.map(i=>e.jsx(z,{children:e.jsxs("div",{className:"max-w-full",children:[e.jsx(l,{children:e.jsx(O,{children:i.name})}),i.description&&e.jsx("div",{className:"truncate",title:i.description,children:i.description})]})},i.id)),n.tasks.length===0&&e.jsxs("div",{className:"mt-4",children:[e.jsx(l,{className:"text-center italic",children:"该管道未定义任何任务，无法运行"}),e.jsx("div",{className:"text-center mt-2 text-sm",children:e.jsxs("a",{href:"https://yhdsl.github.io/plombery/tasks/",target:"_blank",className:"inline-flex items-center gap-2 bg-indigo-50/30 hover:bg-indigo-50 dark:bg-indigo-950/50 dark:hover:bg-indigo-950 rounded-sm px-4 py-2 text-indigo-500 transition-colors duration-300 cursor-pointer no-underline",rel:"noopener noreferrer",children:["如何创建任务",e.jsx(w,{icon:D,size:"sm",className:"p-0",color:"indigo"})]})})]})]}),e.jsx("div",{style:{flexGrow:1}}),e.jsxs(j,{className:"justify-between gap-8",children:[e.jsx(l,{children:"运行 URL"}),e.jsx(ds,{pipelineId:t})]})]}),e.jsx(cs,{subject:"Pipeline",query:a}),e.jsx(ls,{query:a})]}),e.jsxs(F,{numItems:1,numItemsSm:1,numItemsMd:1,numItemsLg:2,className:"gap-6 mt-6",children:[e.jsx(H,{children:e.jsx(Xt,{pipeline:n})}),e.jsx(H,{children:e.jsx(Re,{query:a,pipelineId:t})})]})]})},sr=({trigger:s})=>{const[t,r]=d.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx(N,{color:"indigo",variant:"light",size:"sm",icon:et,onClick:()=>r(!0),children:"查看参数"}),e.jsx(q,{isOpen:t,title:"触发器参数",subtitle:s.name,footer:e.jsx(N,{variant:"primary",color:"indigo",onClick:()=>{r(!1)},children:"关闭"}),onClose:()=>r(!1),children:e.jsx("pre",{className:"p-3 bg-slate-100 dark:bg-dark-tremor-background-subtle dark:text-dark-tremor-content-emphasis rounded-md",children:JSON.stringify(s.params,null,2)})})]})},J={id:"_manual",name:"手动运行",description:"代表由用户手动运行管道的特殊触发器"},tr=()=>{const s=X(),t=ve(),r=t.pipelineId,a=t.triggerId,n=T(_e(r)),i=T({...$e(r,a),enabled:!!a}),m=Ke({...Ze(r,a),onSuccess(p){s(`/pipelines/${p.pipeline_id}/triggers/${p.trigger_id}/runs/${p.id}`)}});if(n.isPending)return e.jsx("div",{children:"加载中..."});if(n.isError)return e.jsx("div",{children:"出现了一个错误"});const c=n.data,h=a===J.id,o=h?J:c.triggers.find(p=>p.id===a);if(!o)return e.jsx("div",{children:"未找到触发器"});const x=h?e.jsx(Te,{pipeline:c}):e.jsx(N,{size:"xs",color:"indigo",variant:"secondary",icon:de,onClick:()=>{m.mutateAsync()},children:"运行"});return e.jsxs(re,{header:e.jsxs("div",{children:[e.jsxs(j,{className:"items-start",children:[e.jsxs(j,{className:"justify-start items-start md:items-center flex-col md:flex-row min-w-0",children:[e.jsxs(k,{className:"truncate max-w-full",children:['触发器 "',o.name,'"']}),o.description&&e.jsxs(l,{className:"truncate max-w-full",children:[e.jsx("span",{className:"hidden md:inline mx-2",children:"·"}),o.description]})]}),x]}),e.jsx(Ce,{pipeline:c,trigger:o,className:"mt-4 md:mt-0"})]}),children:[e.jsxs(F,{numItemsMd:2,numItemsLg:3,className:"gap-6 mt-6",children:[e.jsxs(y,{className:"flex flex-col h-full",children:[e.jsx(k,{children:o.name}),e.jsx(W,{children:o.description}),e.jsx("div",{style:{flexGrow:1}}),e.jsxs(z,{children:[e.jsx(l,{children:"调度"}),e.jsx(l,{children:e.jsx(O,{children:o.schedule})})]}),e.jsxs(z,{children:[e.jsx(l,{children:"参数"}),o.params?e.jsx(sr,{trigger:o}):e.jsx(l,{children:e.jsx("em",{children:"无参数"})})]}),e.jsxs(j,{className:"",children:[e.jsx(l,{children:"运行 URL"}),e.jsx(ds,{pipelineId:r,triggerId:a})]})]}),e.jsx(cs,{subject:"Trigger",query:i}),e.jsx(ls,{query:i})]}),e.jsx("div",{className:"mt-6",children:e.jsx(Re,{query:i,pipelineId:r,triggerId:a})})]})},rr=({logEntry:s})=>{const[t,r]=d.useState(!1);return e.jsxs(j,{className:"mt-1",children:[e.jsx(N,{color:"rose",variant:"secondary",size:"xs",onClick:()=>r(!0),children:"异常栈信息"}),e.jsx(q,{isOpen:t,title:"异常栈信息",footer:e.jsx(N,{variant:"primary",color:"indigo",onClick:()=>{r(!1)},children:"关闭"}),onClose:()=>r(!1),children:e.jsx("div",{className:"flex flex-col",children:e.jsx("div",{style:{minWidth:350,maxWidth:"100%",overflow:"auto",flexGrow:1,maxHeight:"70vh"},className:"p-3 my-3 bg-tremor-background-subtle dark:bg-dark-tremor-background-subtle rounded-md whitespace-pre font-mono",children:s.exc_info})})})]})},nr=30,He={DEBUG:"slate",INFO:"sky",WARNING:"amber",ERROR:"rose"},ar=({pipeline:s,run:t})=>{const[r,a]=d.useState({levels:[],tasks:[]}),[n,i]=d.useState(!0),m=pe(),c=d.createRef(),h=T(Nt(t.id)),o=d.useCallback(u=>{m.setQueryData(["logs",t.id],(g=[])=>{const b=JSON.parse(u);return b.id=g.length,b.timestamp=new Date(b.timestamp),[...g,b]})},[t.id]),x=d.useCallback(u=>{var Pe;const g=(Pe=c.current)==null?void 0:Pe.parentElement;if(!g)return;const b=u;let R=Math.max(g.scrollTop+g.clientHeight+b.deltaY,0);R=Math.min(R,g.scrollHeight);const ms=g.scrollHeight-R<nr;i(ms)},[c]);d.useEffect(()=>{var u,g;return(g=(u=c.current)==null?void 0:u.parentElement)==null||g.addEventListener("wheel",x),()=>{var b,R;(R=(b=c.current)==null?void 0:b.parentElement)==null||R.removeEventListener("wheel",x)}},[c]),d.useEffect(()=>{var u;if(n){const g=(u=c.current)==null?void 0:u.parentElement;g==null||g.scrollTo({top:g.scrollHeight,behavior:"smooth"})}}),d.useEffect(()=>(E.on(`logs.${t.id}`,o),()=>{E.off(`logs.${t.id}`,o)}),[]);const p=d.useCallback(u=>{a(g=>({...g,...u}))},[]);if(h.isPending)return e.jsx("div",{children:"加载中..."});if(h.isError)return e.jsx("div",{children:"加载日志时出错"});const S=h.data.filter(u=>(r.levels.length===0||r.levels.includes(u.level))&&(r.tasks.length===0||r.tasks.includes(u.task))),_=rs(s.tasks),f=["running","pending"].includes(t.status);return e.jsxs(j,{flexDirection:"col",alignItems:"stretch",style:{maxHeight:600},children:[e.jsxs(F,{numItemsMd:3,className:"gap-6 items-start",children:[e.jsxs("div",{children:[e.jsx(l,{children:"任务"}),e.jsx(Oe,{className:"mt-1 z-20",onValueChange:u=>{p({tasks:u})},placeholder:"选择...",placeholderSearch:"搜索",children:s.tasks.map(u=>e.jsx(Le,{value:u.id,children:u.name},u.id))})]}),e.jsxs("div",{children:[e.jsx(l,{children:"日志等级"}),e.jsx(Oe,{className:"mt-1 z-20",onValueChange:u=>{p({levels:u})},placeholder:"选择...",placeholderSearch:"搜索",children:Object.keys(He).map(u=>e.jsx(Le,{value:u},u))})]}),f&&e.jsxs(j,{justifyContent:"end",className:"order-first md:order-last",children:[e.jsx(w,{icon:st,variant:"light",color:n?"indigo":"gray",tooltip:"自动滚动至最新的日志。单击进行切换",className:"mr-4",style:{cursor:"pointer"},onClick:()=>{i(!n)}}),e.jsxs("span",{className:"relative flex h-3 w-3",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-3 w-3 bg-indigo-500"})]}),e.jsx(l,{className:"ml-2 opacity-80",children:"实时日志"})]})]}),e.jsxs(fe,{className:"mt-6 flex-grow",ref:c,children:[e.jsx(be,{className:"sticky top-0 bg-tremor-background dark:bg-dark-tremor-background shadow dark:shadow-tremor-dropdown z-9",children:e.jsxs(C,{children:[e.jsx($,{children:"时间"}),e.jsx($,{children:"等级"}),e.jsx($,{children:"任务"}),e.jsx($,{children:"消息"})]})}),e.jsx(ye,{children:S.map((u,g)=>{const b=g!==0?u.timestamp.getTime()-S[g-1].timestamp.getTime():-1;return e.jsxs(C,{children:[e.jsx(v,{children:e.jsxs(l,{className:"font-mono text-xs",children:[e.jsx("span",{title:B(u.timestamp,!1),children:B(u.timestamp)}),b>=0&&e.jsxs("span",{className:"text-slate-400 ml-2",children:["+",qt(b)," ms"]})]})}),e.jsx(v,{children:e.jsx(Je,{size:"xs",color:He[u.level],children:u.level})}),e.jsx(v,{children:e.jsxs(j,{children:[e.jsx("div",{className:`h-2 w-2 mr-2 rounded-full ${_[u.task]}`}),u.task]})}),e.jsxs(v,{className:"w-full",children:[e.jsx(l,{children:u.message}),u.exc_info&&e.jsx(rr,{logEntry:u})]})]},u.id)})})]})]})},ir=Ne.lazy(()=>We(()=>import("./HandsonTable-DMb9EuCm.js"),__vite__mapDeps([0,1,2]))),or=Ne.lazy(()=>We(()=>import("./main-D06-F-Jc.js").then(s=>s.m),__vite__mapDeps([3,1]))),lr=({data:s})=>{const t=document.documentElement.classList.contains("dark");return e.jsx("div",{className:"border dark:border-slate-800 rounded-lg",children:e.jsx(d.Suspense,{fallback:e.jsx("div",{children:"Loading table UI..."}),children:e.jsx(or,{src:s,collapseStringsAfterLength:50,iconStyle:"triangle",theme:t?"summerfruit":"summerfruit:inverted",style:{padding:24,borderRadius:"inherit"}})})})},cr=({data:s})=>e.jsx("div",{className:"border dark:border-slate-800 rounded-lg p-6",children:JSON.stringify(s)}),dr=({data:s})=>Array.isArray(s)&&typeof s[0]=="object"?e.jsx(d.Suspense,{fallback:e.jsx("div",{children:"Loading table UI..."}),children:e.jsx(ir,{data:s,rowHeaders:!0,colHeaders:Object.keys(s[0]),height:"70vh",width:"700px",licenseKey:"non-commercial-and-evaluation"})}):typeof s=="object"&&s!==null?e.jsx(lr,{data:s}):e.jsx(cr,{data:s}),mr=({runId:s,taskId:t,open:r,onClose:a})=>{const n=T({...wt(s,t),enabled:r});return e.jsx(e.Fragment,{children:e.jsxs(q,{title:t,subtitle:"任务数据",isOpen:r,footer:e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"secondary",color:"indigo",onClick:()=>a(),children:"关闭"}),e.jsxs("a",{href:`${ke()}/${Xe(s,t)}`,target:"_blank",className:"tremor-Button-root flex-shrink-0 inline-flex justify-center items-center group font-medium outline-none rounded-tremor-default shadow-tremor-input dark:shadow-dark-tremor-input border px-4 py-2 text-sm bg-indigo-500 border-indigo-500 text-white hover:bg-indigo-600 hover:border-indigo-700 no-underline hover:text-inherit",rel:"noopener noreferrer",children:[e.jsx(tt,{className:"tremor-Button-icon shrink-0 h-5 w-5 -ml-1 mr-1.5"}),"下载"]})]}),onClose:a,children:[n.isPending&&e.jsx("div",{children:"加载中..."}),n.isError&&(n.error.response.status===404?e.jsx(l,{children:"该任务无数据输出"}):e.jsxs(l,{color:"rose",children:["获取数据时出错: ",n.error.message]})),!n.isPending&&!n.isError&&e.jsx(dr,{data:n.data})]})})},ur=({pipeline:s,run:t})=>{const[r,a]=d.useState(),n=rs(s.tasks);return e.jsxs(y,{children:[e.jsx(mr,{runId:t.id,taskId:r||"",open:!!r,onClose:()=>a(void 0)}),e.jsx(k,{children:"任务"}),e.jsx(Y,{children:s.tasks.map((i,m)=>{var c;return e.jsxs(z,{className:"space-x-4",children:[t.tasks_run&&t.tasks_run[m]?e.jsx(w,{variant:"light",icon:xe[t.tasks_run[m].status],color:K[t.tasks_run[m].status]}):e.jsx(w,{variant:"light",icon:xe.pending,color:K.pending}),e.jsxs("div",{className:"truncate flex-grow",children:[e.jsxs(j,{className:"justify-start",children:[e.jsx("div",{className:`h-2 w-2 mr-2 rounded-full ${n[i.id]}`}),e.jsx(W,{className:"truncate text-base text-tremor-content-emphasis dark:text-dark-tremor-content-emphasis",children:i.name})]}),i.description&&e.jsx(l,{className:"truncate",children:i.description})]}),t.tasks_run&&((c=t.tasks_run[m])==null?void 0:c.has_output)&&e.jsx(N,{variant:"light",color:"indigo",size:"xs",icon:rt,onClick:()=>a(i.id),children:"查看数据"})]},i.id)})})]})},xr=()=>{const s=pe(),t=ve(),r=t.pipelineId,a=t.triggerId,n=parseInt(t.runId);d.useEffect(()=>{const f=()=>{s.invalidateQueries({queryKey:Me(r,a,n).queryKey})};return E.on("run-update",f),()=>{E.off("run-update",f)}},[r]);const i=T(_e(r)),m=T(Me(r,a,n));if(i.isPending)return e.jsx("div",{children:"加载中..."});if(i.isError)return e.jsx("div",{children:"错误"});const c=i.data,o=a===J.id?J:c.triggers.find(f=>f.id===a),x=m.data;if(!x)return e.jsx("div",{children:"未找到运行数据"});if(!o)return e.jsx("div",{children:"未找到触发器"});const p=(x.tasks_run||[]).reduce((f,u)=>f+u.duration,0),S=(x.tasks_run||[]).map(f=>p?f.duration/p*100:0),_=nt(x.start_time,x.duration);return e.jsxs(re,{header:e.jsxs(e.Fragment,{children:[e.jsxs(k,{children:['运行ID "#',n,'"']}),e.jsx(Ce,{pipeline:c,trigger:o,run:x})]}),children:[e.jsxs(F,{numItemsMd:3,className:"gap-6 mt-6",children:[e.jsx(ur,{pipeline:c,run:x}),e.jsxs(y,{children:[e.jsxs(j,{className:"items-start",children:[e.jsx(l,{children:"耗时"}),e.jsx(as,{status:x.status})]}),e.jsx(j,{className:"justify-start items-baseline space-x-3 truncate",children:e.jsxs(ee,{children:[x.status!=="running"?(x.duration/1e3).toFixed(2):e.jsx(is,{startTime:x.start_time})," ","s"]})}),e.jsx(at,{values:S,colors:he,showLabels:!1,className:"mt-3"}),e.jsxs(j,{alignItems:"start",className:"mt-2",children:[e.jsxs("div",{children:[e.jsx(l,{children:e.jsx(O,{title:A(x.start_time,!1),children:B(x.start_time)})}),e.jsx(l,{className:"mt-1",children:Q(x.start_time)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(l,{children:e.jsx(O,{title:A(_,!1),children:B(_)})}),!it(x.start_time,_)&&e.jsx(l,{children:Q(_)})]})]})]})]}),e.jsx("div",{className:"mt-6",children:e.jsx(y,{children:e.jsx(ar,{pipeline:c,run:x})})})]})},hr=({children:s})=>{const{isAuthenticated:t,isLoading:r}=Se(),a=ot();return!t&&!r?e.jsx(lt,{to:"/login",replace:!0,state:{from:a}}):e.jsx(e.Fragment,{children:s})},jr=Object.assign({"./pages/index.tsx":Qt,"./pages/login.tsx":Jt,"./pages/pipelines/[pipelineId]/index.tsx":er,"./pages/pipelines/[pipelineId]/triggers/[triggerId]/index.tsx":tr,"./pages/pipelines/[pipelineId]/triggers/[triggerId]/runs/[runId]/index.tsx":xr}),gr=Object.entries(jr).map(([s,t])=>{const r=s.slice(7).replace(/(index)?\.tsx$/,"").split("/").map(a=>a.replace(/\[(.+)\]/,":$1")).join("/");return{path:r,element:r!=="/login"?e.jsx(hr,{children:e.jsx(t,{})}):e.jsx(t,{})}}),pr=()=>e.jsx(ct,{children:gr.map(s=>e.jsx(dt,{path:s.path,element:s.element},s.path))}),fr=({children:s})=>{const[t,r]=d.useState(E.connected);return d.useEffect(()=>{function a(){r(!0)}function n(){r(!1)}return E.on("connect",a),E.on("disconnect",n),()=>{E.off("connect",a),E.off("disconnect",n)}},[]),s},br=new mt({defaultOptions:{queries:{retry:!1}}});function yr(){return e.jsx(ut,{client:br,children:e.jsx(fr,{children:e.jsx(xt,{children:e.jsx($t,{children:e.jsx(pr,{})})})})})}ht.createRoot(document.getElementById("root")).render(e.jsx(Ne.StrictMode,{children:e.jsx(yr,{})}));
